# Liveness Detection & Anti-Spoofing App

이 프로젝트는 웹캠을 사용하여 사용자의 "라이브니스(Liveness, 실제 사람인지 여부)"를 검증하고, 사전에 등록된 데이터베이스(DB) 사진과 대조하여 본인 인증(Identity Verification)을 수행하는 Python 애플리케이션입니다.

## 🚀 주요 기능 (3-Gate 시스템)
1. **Gate 1: 무작위 미션 수행 (Liveness)**
   - 스마일, 입 벌리기, 고개 돌리기 등의 미션을 화면에 랜덤으로 제시하고 제한 시간(3초) 내에 수행하는지 MediaPipe 점(Landmark) 추적을 통해 판별합니다.
2. **Gate 2: 비디오 리플레이 및 마스크 방어 (Consistency / Optical Flow)**
   - 테스트 시작 시 얼굴과 미션 중 얼굴이 동일한지(바꿔치기 방지) 검사합니다.
   - 배경 움직임(Optical Flow)을 추적하여 화면 전체가 흔들리는 Video Replay 공격을 방어합니다.
3. **Gate 3: 신원 확인 (Identity Verification)**
   - `user_db/` 폴더 내에 저장된 사진들과 사용자의 프레임을 대조하여 본인이 맞는지(`ACCESS GRANTED` / `ACCESS DENIED`) 최종 판단합니다.

## �️ 안티 스푸핑 (가짜 감지) 방어 원리
본 시스템은 다음과 같은 방식으로 다양한 해킹/위조 시도를 차단합니다.

- **딥페이크(Deepfake) 및 얼굴 스왑 방어**:
  - 미션(예: 스마일) 진행 중 찰나의 순간에 **"미션 시작 전 얼굴"**과 **"미션 진행 중 얼굴"**을 DeepFace CNN 모델로 실시간 대조(Consistency Check)합니다.
  - 딥페이크나 필터 앱이 표정 변화(입 벌리기 등) 과정에서 순간적으로 렌더링에 실패하거나 얼굴 특징이 틀어지는 약점을 캐치하여 스왑(바꿔치기) 여부를 적발합니다.
- **비디오 리플레이 (휴대폰 영상 재생) 방어**:
  - 카메라 앞에서 미리 촬영된 동영상을 재생하는 경우, 휴대폰을 들고 있는 손이 미세하게 떨릴 수밖에 없습니다.
  - **광학 흐름(Optical Flow)** 기능을 통해 사용자의 코끝 움직임과 얼굴 주변(배경)의 움직임 벡터를 추적합니다. 배경 픽셀들이 코와 완벽하게 1:1로 동일한 궤적과 속도로 움직인다면, 입체적인 3D 공간이 아닌 2D 평면(스마트폰 화면)으로 간주하여 즉시 차단합니다.
- **3D 마스크 및 사진 공격 (출력물) 방어**:
  - 고유한 랜덤 미션(Randomized Challenge-Response)을 통해 무작위 타이밍에 미션을 지시합니다. 시간 내에 안면 근육(Landmark)이 완벽한 조건에 맞게 움직여야 하므로, 정지된 사진이나 딱딱한 가면 형태의 3D 마스크로는 미션을 통과할 수 없습니다.

## �📥 설치 및 실행 방법

### 1. 패키지 설치
Python 3.10 이상이 필요합니다. 가상환경(venv 등)을 세팅한 후 아래 명령어로 라이브러리를 설치해 주세요.
```bash
pip install -r requirements.txt
```

### 2. 신원 확인용 DB 세팅 (`user_db`)
얼굴을 대조할 **사용자 원본 사진**들을 준비해야 합니다. (이 사진이 없으면 신원 확인 단계는 스킵됩니다.)
1. 프로젝트 루트 폴더에 `user_db` 라는 이름의 폴더를 생성합니다.
2. 얼굴이 크고 선명하게 나온 정면 사진(예: 증명사진, 꽉 찬 셀카)을 `user_db/` 디렉토리 안에 넣습니다. (`.jpg`, `.png` 등)
   - *주의: 사진에 배경이 너무 많거나 다른 사람이 포함되어 있으면 인식(Distance)에 오류가 발생할 수 있습니다.*

### 3. CNN 모델 변경 (선택 사항)
본 프로그램은 `DeepFace` 라이브러리를 사용하여 얼굴을 인증합니다. 기본적으로 높은 정확도를 가진 **`ArcFace`** 엔진과 **`opencv`** 얼굴 탐지기(`detector_backend`)를 사용하도록 `anti_spoofing_app.py` 530번대 라인 근처에 설정되어 있습니다.
속도나 정확성 취향에 따라 코드를 수정하여 `Facenet`, `SFace`, `VGG-Face` 등으로 변경하여 사용할 수 있습니다.
* (최초 실행 시 선택한 얼굴 인식 모델의 가중치 파일이 `~/.deepface/weights` 경로에 자동 다운로드됩니다.)

### 4. 프로그램 실행
```bash
python3 anti_spoofing_app.py
```
실행 후 `START TEST` 버튼을 누르고 화면에 나오는 미션에 맞춰 얼굴을 움직이면 테스트가 진행됩니다.
